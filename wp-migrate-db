#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Uso:
  wp-migrate-db [--src-wp=<id>] [--src-db=<id>] [--dest-wp=<id>] [--dest-db=<id>] [--src-domain=<dominio>] [--dest-domain=<dominio>]
  wp-migrate-db <src-wp-container-id> <src-db-container-id> <dest-wp-container-id> <dest-db-container-id> <src-domain> <dest-domain>

Descripci√≥n:
  Extrae la base de datos del entorno fuente (src), la importa en el entorno de destino (dest),
  y realiza un search-replace reemplazando el dominio de la fuente por el de destino.

Par√°metros:
  --src-wp       ID o nombre del contenedor WordPress de origen
  --src-db       ID o nombre del contenedor de la DB de origen
  --dest-wp      ID o nombre del contenedor WordPress de destino
  --dest-db      ID o nombre del contenedor DB de destino
  --src-domain   Dominio del sitio en el origen (con protocolo, ej: https//cuadrado.dev)
  --dest-domain  Dominio del sitio en el destino (con protocolo, ej: https://staging.cuadrado.dev)

Ejemplo:
  wp-migrate-db \\
    --src-wp=wp_prod_1 --src-db=db_prod_1 \\
    --dest-wp=wp_staging_1 --dest-db=db_staging_1 \\
    --src-domain=https://cuadrado.dev \\
    --dest-domain=https://staging.cuadrado.dev
EOF
}

error_exit() {
  echo "‚ùå Error: $1" >&2
  echo
  usage
  exit 1
}

SRC_WPCLI=""
DEST_WPCLI=""
SRC_DOMAIN=""
DEST_DOMAIN=""
TMP_SQL="/tmp/src-db.sql"

SRC_WP=""
SRC_DB_HOST=""
SRC_DB_USER=""
SRC_DB_PASS=""
SRC_DB_NAME=""
SRC_DB_CONTAINER=""

DEST_WP=""
DEST_DB_HOST=""
DEST_DB_USER=""
DEST_DB_PASS=""
DEST_DB_NAME=""
DEST_DB_CONTAINER=""

parse_and_validate_args() {
  declare -g SRC_WP SRC_DB_CONTAINER DEST_WP DEST_DB_CONTAINER SRC_DOMAIN DEST_DOMAIN

  # Si no hay args mostrar ayuda
  if (( $# == 0 )); then
    usage
    exit 1
  fi

  # Parsing
  while (( $# > 0 )); do
    case "$1" in
      --src-wp=*) SRC_WP="${arg#*=}" ;;
      --src-db=*) SRC_DB_CONTAINER="${arg#*=}" ;;
      --dest-wp=*) DEST_WP="${arg#*=}" ;;
      --dest-db=*) DEST_DB_CONTAINER="${arg#*=}" ;;
      --src-domain=*) SRC_DOMAIN="${arg#*=}" ;;
      --dest-domain=*) DEST_DOMAIN="${arg#*=}" ;;
      -h|--help ) usage; exit 0 ;;
      * )
        if [[ -z "$SRC_WP" ]]; then
          SRC_WP="$1"
        elif [[ -z "$SRC_DB_CONTAINER" ]]; then
          SRC_DB_CONTAINER="$1"
        elif [[ -z "$DEST_WP" ]]; then
          DEST_WP="$1"
        elif [[ -z "$DEST_DB_CONTAINER" ]]; then
          DEST_DB_CONTAINER="$1"
        elif [[ -z "$SRC_DOMAIN" ]]; then
          SRC_DOMAIN="$1"
        elif [[ -z "$DEST_DOMAIN" ]]; then
          DEST_DOMAIN="$1"
        else
          error_exit "Argumento desconocido: $1"
        fi
        ;;
    esac
    shift || break
  done

  # Validaci√≥n
  [[ -z "${SRC_WP:-}" ]] && error_exit "Falta el contenedor WordPress de origen (--src-wp o primer par√°metro)"
  [[ -z "${SRC_DB_CONTAINER:-}" ]] && error_exit "Falta contenedor de la DB de origen (--src-db o segundo par√°metro)"
  [[ -z "${DEST_WP:-}" ]] && error_exit "Falta el contenedor WordPress de dest (--dest-wp o tercer par√°metro)"
  [[ -z "${DEST_DB_CONTAINER:-}" ]] && error_exit "Falta el contenedor DB de destino (--dest-db o cuarto par√°metro)"
  [[ -z "${SRC_DOMAIN:-}" ]] && error_exit "Falta el dominio del sitio en origen (--src-domain o quinto par√°metro)"
  [[ -z "${DEST_DOMAIN:-}" ]] && error_exit "Falta el dominio del sitio en destino (--dest-domain o sexto par√°metro)"
  echo
}


get_wp_info() {
  local id="$1"
  local env_str="$2"
  local inspect db_host db_user db_pass db_name

  inspect=$(docker inspect "$id") || error_exit "No se pudo inspeccionar el contenedor $id"

  db_user=$(echo "$inspect" | grep -o '"WORDPRESS_DB_USER=[^"]*' | cut -d= -f2)
  db_host=$(echo "$inspect" | grep -o '"WORDPRESS_DB_HOST=[^"]*' | cut -d= -f2)
  db_pass=$(echo "$inspect" | grep -o '"WORDPRESS_DB_PASSWORD=[^"]*' | cut -d= -f2)
  db_name=$(echo "$inspect" | grep -o '"WORDPRESS_DB_NAME=[^"]*' | cut -d= -f2)

  [[ -z "$db_host" || -z "$db_user" || -z "$db_pass" || -z "$db_name" ]] && error_exit "No se pudieron obtener las variables de entorno de la BD para $env_str"
  
  echo "$db_host|$db_user|$db_pass|$db_name"
}


set_variables_with_containers_data() {
  declare -g TMP_SQL SRC_DB_HOST SRC_DB_USER SRC_DB_PASS SRC_DB_NAME STAGING_HTML_PATH DEST_DB_HOST DEST_DB_USER DEST_DB_PASS DEST_DB_NAME
  
  echo "üîç Obteniendo informaci√≥n de producci√≥n y staging..."
  IFS='|' read -r SRC_DB_HOST SRC_DB_USER SRC_DB_PASS SRC_DB_NAME <<<"$(get_wp_info "$SRC_WP" "producci√≥n")"
  IFS='|' read -r DEST_DB_HOST DEST_DB_USER DEST_DB_PASS DEST_DB_NAME <<<"$(get_wp_info "$DEST_WP" "staging")"

  if [[ "$SRC_DB_HOST" != *:* ]]; then
      SRC_DB_HOST="${SRC_DB_HOST}:3306"
  fi
  if [[ "$DEST_DB_HOST" != *:* ]]; then
      DEST_DB_HOST="${DEST_DB_HOST}:3306"
  fi

  TMP_SQL="/tmp/$(echo $SRC_DOMAIN | tr -cd '[:alnum:]')_$(head -c 64 /dev/urandom | tr -dc 'a-z0-9' | fold -w 5 | head -1).sql"
}


create_wpcli_container_and_network() {
  if ! docker network ls --format '{{.Name}}' | grep -q '^wpcli$'; then
    echo "üåê Creando red 'wpcli'..."
    docker network create wpcli >/dev/null
  fi
}


connect_containers_to_wpcli_net() {
  echo "üîó Conectando contenedores a la red wpcli..."
  for c in "$SRC_WP" "$SRC_DB_CONTAINER" "$DEST_WP" "$DEST_DB_CONTAINER"; do
    docker network connect wpcli "$c" 2>/dev/null || true
  done

  echo "üì° Comprobando visibilidad de las bases de datos en la red temporal..."
  DB_HOST_NC=$(echo "$SRC_DB_HOST" | cut -d: -f1)
  DB_PORT_NC=$(echo "$SRC_DB_HOST" | cut -d: -f2)

  TEMP_CONTAINER=$(docker run -d --rm --network wpcli wordpress:cli tail -f /dev/null)

  if ! docker exec $TEMP_CONTAINER /bin/bash -c "nc -vz $DB_HOST_NC $DB_PORT_NC" >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Haciendo fallback para el host de la BD de origen..."
    DB_INSPECT=$(docker inspect "$SRC_DB_CONTAINER") || error_exit "No se pudo inspeccionar el contenedor de la BD de origen"
    DB_CONTAINER_NAME=$(echo "$DB_INSPECT" | grep '"Name":' | head -1 | cut -d: -f2 | tr -d '", ' | sed 's/^\///')
    [[ -z "$DB_CONTAINER_NAME" ]] && error_exit "No se pudo obtener el nombre del contenedor de la BD de origen para el fallback."
    
    SRC_DB_HOST="${DB_CONTAINER_NAME}:${DB_PORT_NC}"
    echo "‚ôªÔ∏è  Usando fallback con nombre del contenedor: $SRC_DB_HOST"
  else
    echo "‚úÖ La BD de origen es visible."
  fi

  DB_HOST_NC=$(echo "$DEST_DB_HOST" | cut -d: -f1)
  DB_PORT_NC=$(echo "$DEST_DB_HOST" | cut -d: -f2)

  if ! docker exec $TEMP_CONTAINER /bin/bash -c "nc -vz $DB_HOST_NC $DB_PORT_NC" >/dev/null 2>&1; then
    echo "‚ö†Ô∏è  Haciendo fallback para el host de la BD de destino..."
    DB_INSPECT=$(docker inspect "$DEST_DB_CONTAINER") || error_exit "No se pudo inspeccionar el contenedor de la BD de destino"
    DB_CONTAINER_NAME=$(echo "$DB_INSPECT" | grep '"Name":' | head -1 | cut -d: -f2 | tr -d '", ' | sed 's/^\///')
    [[ -z "$DB_CONTAINER_NAME" ]] && error_exit "No se pudo obtener el nombre del contenedor de la BD de destino para el fallback."
    
    DEST_DB_HOST="${DB_CONTAINER_NAME}:${DB_PORT_NC}"
    echo "‚ôªÔ∏è  Usando fallback con nombre del contenedor: $DEST_DB_HOST"
  else
    echo "‚úÖ La BD de destino es visible."
  fi
  
  docker rm -f $TEMP_CONTAINER >/dev/null 2>&1 || true
}


sync_databases() {
  declare -g SRC_WPCLI DEST_WPCLI
  echo "üöÄ Levantando contenedores temporales..."
  SRC_WPCLI=$(docker run -d --rm -it \
    --volumes-from "$SRC_WP" \
    --network wpcli \
    -e WORDPRESS_DB_HOST="${SRC_DB_HOST}" \
    -e WORDPRESS_DB_USER="${SRC_DB_USER}" \
    -e WORDPRESS_DB_PASSWORD="${SRC_DB_PASS}" \
    -e WORDPRESS_DB_NAME="${SRC_DB_NAME}" \
    wordpress:cli tail -f /dev/null)

  DEST_WPCLI=$(docker run -d --rm \
    --volumes-from "$DEST_WP" \
    --network wpcli \
    -e WORDPRESS_DB_HOST="${DEST_DB_HOST}" \
    -e WORDPRESS_DB_USER="${DEST_DB_USER}" \
    -e WORDPRESS_DB_PASSWORD="${DEST_DB_PASS}" \
    -e WORDPRESS_DB_NAME="${DEST_DB_NAME}" \
    wordpress:cli tail -f /dev/null)
  
  # WP-CLI usa mariadb, si se intenta importar o exportar una bd mysql falla. Estas lineas comprueban 
  # si las bd son mysql; si lo son, instala el paquete mariadb-connector-c para corregir el error.
  docker inspect --format='{{.Config.Image}}' "$SRC_DB_CONTAINER" | grep -iq "mysql" && docker exec --user root "$SRC_WPCLI" sh -c "apk update && apk add mariadb-connector-c --no-cache" >/dev/null
  docker inspect --format='{{.Config.Image}}' "$DEST_DB_CONTAINER" | grep -iq "mysql" && docker exec --user root "$DEST_WPCLI" sh -c "apk update && apk add mariadb-connector-c --no-cache" >/dev/null
  
  echo "‚¨áÔ∏è Exportando base de datos desde el origen..."
  docker exec $SRC_WPCLI wp db export $TMP_SQL --path=/var/www/html --allow-root >/dev/null

  echo "‚¨ÜÔ∏è Importando base de datos al destino..."
  docker cp $SRC_WPCLI:$TMP_SQL $TMP_SQL >/dev/null && docker cp $TMP_SQL $DEST_WPCLI:$TMP_SQL >/dev/null
  docker exec $DEST_WPCLI wp db import $TMP_SQL --path=/var/www/html --allow-root >/dev/null

  echo "üîç Reemplazando '$SRC_DOMAIN' por '$DEST_DOMAIN'..."
  REPLACE_COUNT=$(docker exec $DEST_WPCLI wp search-replace "$SRC_DOMAIN" "$DEST_DOMAIN" --format=count --path=/var/www/html)

  echo "üîÅ Reemplazados $REPLACE_COUNT registros de '$SRC_DOMAIN' por '$DEST_DOMAIN'."
  echo "‚úÖ Sincronizaci√≥n completada correctamente."
}


cleanup() {
  rm -f $TMP_SQL >/dev/null 2>&1 || true    
  docker rm -f $DEST_WPCLI >/dev/null 2>&1 || true
  docker rm -f $SRC_WPCLI >/dev/null 2>&1 || true
  for c in "$SRC_WP" "$SRC_DB_CONTAINER" "$DEST_WP" "$DEST_DB_CONTAINER"; do
    docker network disconnect wpcli "$c" 2>/dev/null || true
  done
}
trap cleanup EXIT


main() {
  parse_and_validate_args "$@"
  set_variables_with_containers_data
  create_wpcli_container_and_network
  connect_containers_to_wpcli_net
  sync_databases
  cleanup
}

main "$@"